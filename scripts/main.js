(async function(){const PATH_POSTS='posts/';function $$(sel,root=document){return root.querySelector(sel);}function formatDate(s){if(!s)return'';try{return new Date(s).toLocaleDateString();}catch(e){return s}}async function loadPostsMeta(){try{const r=await fetch(PATH_POSTS+'posts.json');if(!r.ok)throw new Error('posts.json load failed');return await r.json();}catch(e){console.error(e);return[]}}async function renderIndex(){const listEl=$$('#posts');const tpl=$$('#card-template');const posts=await loadPostsMeta();posts.sort((a,b)=>new Date(b.date)-new Date(a.date));posts.forEach(p=>{const node=tpl.content.cloneNode(true);const media=node.querySelector('.card-media');const title=node.querySelector('.card-title');const excerpt=node.querySelector('.card-excerpt');const date=node.querySelector('.card-date');const more=node.querySelector('.read-more');if(p.cover){media.style.backgroundImage=`url(${p.cover})`;}else{media.style.background='linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))';}title.textContent=p.title;excerpt.textContent=p.excerpt||'';date.textContent=formatDate(p.date);more.href=`post.html?slug=${encodeURIComponent(p.slug)}`;listEl.appendChild(node);});}async function renderPost(){const params=new URLSearchParams(location.search);const slug=params.get('slug');if(!slug)return;const meta=await loadPostsMeta();const item=meta.find(x=>x.slug===slug);const titleEl=$$('#post-title');const dateEl=$$('#post-date');const contentEl=$$('#post-content');if(item){titleEl.textContent=item.title;dateEl.textContent=(item.date)?new Date(item.date).toLocaleDateString():'';}try{const r=await fetch(PATH_POSTS+slug+'.md');if(!r.ok)throw new Error('fetch md failed');const md=await r.text();contentEl.innerHTML=marked.parse(md);}catch(e){contentEl.innerHTML='<p>无法加载文章。</p>';console.error(e);}}if(window.location.pathname.endsWith('index.html')||window.location.pathname==='/'||location.pathname==='')await renderIndex();if(window.location.pathname.endsWith('post.html'))await renderPost();})();